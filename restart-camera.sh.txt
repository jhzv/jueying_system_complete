#!/bin/bash

echo "======================================================"
echo "üìπ REINICIO R√ÅPIDO DE C√ÅMARA"
echo "======================================================"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# 1. Matar procesos de video
echo ""
echo -e "${YELLOW}üßπ Deteniendo servicios de video...${NC}"
sudo pkill -9 ffmpeg 2>/dev/null
sudo pkill -9 -f mediamtx 2>/dev/null
sleep 2

# 2. Verificar c√°mara
echo ""
echo -e "${YELLOW}üìπ Verificando c√°mara...${NC}"
if [ -e /dev/video2 ]; then
    echo -e "${GREEN}‚úì C√°mara detectada en /dev/video2${NC}"
    
    # Liberar si est√° en uso
    if lsof /dev/video2 > /dev/null 2>&1; then
        echo -e "${YELLOW}‚ö† Liberando /dev/video2...${NC}"
        sudo fuser -k /dev/video2 2>/dev/null
        sleep 2
    fi
else
    echo -e "${RED}‚úó ERROR: /dev/video2 no encontrado${NC}"
    echo "Dispositivos disponibles:"
    ls -l /dev/video*
    exit 1
fi

# 3. Reiniciar MediaMTX
echo ""
echo -e "${YELLOW}üöÄ Iniciando MediaMTX...${NC}"
cd ~/mediamtx-server
nohup ./mediamtx > /tmp/mediamtx.log 2>&1 &
sleep 3

# 4. Verificar
if pgrep -f "mediamtx" > /dev/null; then
    echo -e "${GREEN}‚úì MediaMTX corriendo${NC}"
    sleep 2
    
    if pgrep -f "ffmpeg.*video2" > /dev/null; then
        echo -e "${GREEN}‚úì FFmpeg capturando c√°mara${NC}"
    else
        echo -e "${YELLOW}‚ö† FFmpeg no arranc√≥${NC}"
        tail -10 /tmp/mediamtx.log
    fi
else
    echo -e "${RED}‚úó Error al iniciar MediaMTX${NC}"
    tail -20 /tmp/mediamtx.log
    exit 1
fi

echo ""
echo "======================================================"
echo -e "${GREEN}‚úÖ C√ÅMARA REINICIADA${NC}"
echo "======================================================"
echo ""
echo "üì∫ Video disponible en:"
echo "   http://192.168.1.103:8888/robot/"
echo ""
echo "üìù Ver logs:"
echo "   tail -f /tmp/mediamtx.log"
echo ""
